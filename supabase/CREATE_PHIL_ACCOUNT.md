# Create Phil Lisk Account - Proper Method

## âœ… Database Status: CLEAN (As of 2025-10-06)
No users exist in validation lab (ickwrbdpuorzdpzqbqpf) - confirmed via show_all_users.sql

## ğŸš¨ CRITICAL: How to Delete Users (Foreign Key Constraint Issue)

**Problem**: Attempting to delete users from Supabase Dashboard or via SQL fails with:
```
ERROR: 23503: update or delete on table "users" violates foreign key constraint "user_roles_user_id_fkey"
```

**Root Cause**: The `public.user_roles` table has a foreign key to `auth.users` WITHOUT CASCADE delete.

**Solution**: Always delete from `user_roles` FIRST, then delete the user:
```sql
-- 1. Delete from user_roles first
DELETE FROM public.user_roles WHERE user_id = 'USER_UUID_HERE';

-- 2. Delete from auth.identities
DELETE FROM auth.identities WHERE user_id = 'USER_UUID_HERE';

-- 3. Delete from auth.sessions (if any)
DELETE FROM auth.sessions WHERE user_id = 'USER_UUID_HERE';

-- 4. Finally delete from auth.users
DELETE FROM auth.users WHERE id = 'USER_UUID_HERE';
```

**Automated Script**: Use `supabase/delete_both_users_minimal.sql` as a template

## ğŸ¯ Create Phil's Account via Supabase Dashboard

### Step 1: Open Supabase Authentication
1. Go to: https://supabase.com/dashboard/project/ickwrbdpuorzdpzqbqpf/auth/users
2. Click **"Add user"** button (top right)

### Step 2: Enter User Details
```
Email: plisk@design-rite.com
Password: [Use a strong password - Phil will change it on first login]
âœ… Auto Confirm User: YES (check this box)
```

### Step 3: Assign Role via SQL (After Dashboard Creation)
Once the user is created in the Dashboard, run this SQL in Supabase SQL Editor:

```sql
-- Get Phil's user ID (auto-generated by Supabase)
SELECT id, email FROM auth.users WHERE email = 'plisk@design-rite.com';

-- Assign Super Admin role
-- Replace 'USER_ID_HERE' with the actual UUID from above query
INSERT INTO public.user_roles (user_id, role, created_by)
VALUES (
    'USER_ID_HERE',  -- Replace with actual UUID
    'super_admin',
    'system'
);

-- Verify role assignment
SELECT
    u.email,
    ur.role,
    ur.created_at
FROM auth.users u
JOIN public.user_roles ur ON u.id = ur.user_id
WHERE u.email = 'plisk@design-rite.com';
```

## ğŸ” Why This Method Works

**Dashboard Creation Ensures:**
- âœ… Proper password hashing via Supabase Auth
- âœ… auth.identities record created automatically
- âœ… auth.users record with all required fields
- âœ… Email confirmation handled properly
- âœ… No foreign key or RLS issues

**SQL-Created Users Had Issues:**
- âŒ No auth.identities record (invisible to Auth API)
- âŒ Wrong password hashing (bcrypt via SQL doesn't integrate)
- âŒ Missing internal Supabase metadata
- âŒ Can't authenticate even though user exists

## ğŸ“‹ Create Your Account Too (Dan Kozich)

Same process:
1. Dashboard â†’ Add user â†’ dan@design-rite.com or dkozich@design-rite.com
2. Auto-confirm
3. Assign super_admin role via SQL

## ğŸ§ª Create Test Accounts

Same process for test1@design-rite.com, test2@design-rite.com, test3@design-rite.com:
1. Dashboard â†’ Add user
2. Simple password: TestPassword123!
3. Assign 'user' or 'manager' role via SQL (NOT super_admin)

## âœ… Test Login Flow

After creation:
1. Go to: https://cak-end.onrender.com/login (staging)
2. Login with plisk@design-rite.com + password
3. Should redirect to /admin or /estimate-options
4. Logout should work properly (uses NEXT_PUBLIC_APP_URL from .env)

## ğŸš¨ NEVER Create Users via SQL INSERT Again

Always use:
- Supabase Dashboard UI for manual user creation
- Supabase Auth API (`supabase.auth.admin.createUser()`) for programmatic creation
- NEVER direct INSERT into auth.users table
